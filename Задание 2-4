--************************************** shiping


CREATE TABLE shiping
(
 ship_id   int NOT NULL,
 ship_mode varchar(14) NOT NULL,
 CONSTRAINT PK_shiping PRIMARY KEY ( ship_id )
);

truncate table shiping;

--***********ввод данных 

insert into shiping 
select 100+row_number() over() , ship_mode
from (select distinct ship_mode from orders) a;

select * from shiping;



-- ************************************** customer

CREATE TABLE customer
(
 cust_id       int NOT NULL,
 customer_id   varchar(8) NOT NULL,
 customer_name varchar(22) NOT NULL,
 CONSTRAINT PK_customer PRIMARY KEY ( cust_id )
);

truncate table customer;

--***********ввод данных

insert into customer
select 100+row_number() over(),customer_id, customer_name 
from (select distinct customer_id, customer_name  from orders) b;

select * from customer;
 
-- ************************************** geography

drop table geography;

CREATE TABLE geography
(
 geo_id      int NOT NULL,
 country     varchar(13) NOT NULL,
 city        varchar(17) NOT NULL,
 "state"       varchar(20) NOT NULL,
 postal_code varchar(20) NULL,
 CONSTRAINT PK_geograhpy PRIMARY KEY ( geo_id )
);

truncate table geography;

--***********ввод данных

insert into geography
select 100+row_number() over(), country, city, state, postal_code
from (select distinct country, city, state, postal_code from orders) c;

update geography set postal_code = '05401'
where city = 'Burlington' and postal_code is null;

update orders set postal_code = '05401'
where city = 'Burlington' and postal_code is null;

select * from geography ;

-- ************************************** product

drop table product;
CREATE TABLE product
(
 prod_id        serial NOT NULL,
 product_id     varchar(15) NOT NULL,
 product_name varchar(127) NOT NULL,
 category       varchar(15) NOT NULL,
 subcategory    varchar(11) NOT NULL,
 segment        varchar(11) NOT NULL,
 CONSTRAINT PK_product PRIMARY KEY ( prod_id )
);

truncate table product;

--***********ввод данных

insert into product
select 100+row_number() over(), product_id, product_name, category, subcategory, segment
from (select distinct product_id, product_name, category, subcategory, segment from orders) d;

select * from product;

-- ************************************** calendar
drop table calendar;

CREATE TABLE calendar
(
 date_id  serial NOT NULL,
 year     int NOT NULL,
 qualter  int NOT NULL,
 month    int NOT NULL,
 week     int NOT NULL,
 date     date NOT NULL,
 week_day varchar(20) NOT NULL,
 leap     varchar(20) NOT NULL,
 CONSTRAINT PK_calendar PRIMARY KEY ( date_id )
);

insert into calendar 
select to_char(date,'yyyymmdd')::int as date_id,  
       extract('year' from date)::int as year,
       extract('quarter' from date)::int as quarter,
       extract('month' from date)::int as month,
       extract('week' from date)::int as week,
       date::date,
       to_char(date, 'dy') as week_day,
       extract('day' from
               (date + interval '2 month - 1 day')
              ) = 29
       as leap
  from generate_series(date '2000-01-01',
                       date '2030-01-01',
                       interval '1 day')
       as t(date);
      
select * from calendar;

-- ************************************** sales

drop table sales;
CREATE TABLE sales
(
 sales_id      serial NOT NULL,
 cust_id       int NOT NULL,
 ship_id       int NOT NULL,
 geo_id        int4 ,
 prod_id       integer NOT NULL,
 order_date_id int NOT NULL,
 ship_date_id  int NOT NULL,
 order_id      varchar(25) NOT NULL,
 sales         numeric(9,4) NOT NULL,
 profit        numeric(21,16) NOT NULL,
 quantity      int NOT NULL,
 discount      numeric(4,2) NOT NULL,
 CONSTRAINT PK_sales PRIMARY KEY ( sales_id )
 );
	   
insert into sales 
select
	 100+row_number() over() as sales_id,
	 cust_id,
	 s.ship_id,
	 to_char(order_date,'yyyymmdd')::int as  order_date_id,
	 to_char(ship_date,'yyyymmdd')::int as  ship_date_id,
	 p.prod_id,
	 geo_id,
	 o.order_id,
	 sales,
	 profit,
     quantity,
	 discount,
from orders o 
	inner join shiping s on o.ship_mode = s.ship_mode 	
	inner join customer c on o.customer_name = c.customer_name 
						and o.customer_id = c.customer_id 
	inner join geography g on g.postal_code  = o.postal_code 
	   					and g.country = o.country 
						and g.city = o.city
						and g.state = o.state 
	inner join product p on p.product_id = o.product_id 
						and p.category = o.category 
						and p.product_name = o.product_name 
						and p.segment = o.segment 
						and p.subcategory = o.subcategory;
					
select * from sales;
